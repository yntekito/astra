## 1. 想定条件

| 項目 | 内容 |
|------|------|
| テナント数 | 初期：1〜10、最大：100 |
| ユーザー数 | 1テナントあたり10〜100 |
| トラフィック | 1時間あたり 100〜1000 リクエスト |
| データ量（ストック） | 資産情報：1テナントあたり 10〜100 万件 |
| データ量（履歴） | 資産異動履歴：1テナントあたり 100〜1000 万件 |
| トランザクション | 貸出等：1日あたり 10〜1000 件／テナント |
| 性能要件 | 資産検索・画面表示：ミリ秒〜1秒程度 |
| テナント分離 | 論理分離 |
| カスタマイズ性 | 機能の独自差異は最小限、設定レベルでの差異は許容 |
| SSO | SAML 等に対応、独自 IdP 連携あり |
| リージョン | 東京リージョン（バックアップは別リージョン） |
| メトリクス | AWS 提供の監視・ログ基盤を使用（CloudWatch 等） |
| SLA | 高可用性は不要だが最低限の冗長性確保 |
| 将来展望 | モバイルアプリ・外部 API 公開も視野 |
| 言語 / クラウド | C# / AWS |
| アーキテクチャ方針 | API Gateway + Lambda 中心のサーバーレス構成 |

---

## 2. 推奨アーキテクチャ概要

### 2.1 全体構成（論理図）

- **フロントエンド**：SPA (React/Next.js) + Cognito 認証
- **API 層**：API Gateway → Lambda (C# / .NET)
- **データストア**
  - DynamoDB（オンデマンド）: 資産情報、貸出データ
  - S3: 添付ファイル、バックアップ
  - OpenSearch Service: 高速検索・一覧
- **認証・SSO**
  - Amazon Cognito (SAML / OIDC 対応)
- **イベント駆動**
  - DynamoDB Streams → Lambda
  - SQS / EventBridge （非同期処理・ワークフロー）
- **監視 / ログ**
  - CloudWatch Metrics & Logs
  - CloudTrail, X-Ray
- **運用系**
  - Backup: S3 + Cross-Region Replication
  - IaC: AWS CDK or Terraform

---

## 3. サービス課金モデル別分類

### 3.1 リクエスト数に応じて課金されるサービス

| サービス | 課金単位 | 備考 |
|----------|----------|------|
| API Gateway (HTTP API) | リクエスト数 / million | Free tier あり |
| Lambda（リクエスト） | リクエスト数（million） | 実行時間と組み合わせて課金 |
| DynamoDB（オンデマンド） | 読み書きリクエスト数 | 容量は別課金 |
| DynamoDB Streams / SQS | イベント数 / メッセージ数 | 非同期処理連携向け |
| Cognito | 月間アクティブユーザー数 (MAU) | 一部無料枠あり |
| CloudWatch Logs | GB 単位（取り込み量） | ログ出力量で変動 |

---

### 3.2 利用時間に応じて課金されるサービス

| サービス | 課金単位 | 停止可否 | 備考 |
|----------|----------|----------|------|
| OpenSearch Service | インスタンス時間 + ストレージ | ×（ドメイン削除で停止相当） | 検索高速化用。削除復元に時間がかかる |
| ElastiCache (Redis) | インスタンス時間 + ストレージ | ×（削除で停止） | キャッシュ層向け |
| Aurora Serverless / RDS | 時間 or vCPU秒 | ◯（Serverless は自動スケール） | Aurora Serverless v2 はアイドル時自動停止可 |
| EC2 / ECS (Fargate) | インスタンス時間 / vCPU-秒 | ◯（停止または削除） | バッチ・補助処理等向け |
| OpenSearch UltraWarm / Cold | ノード時間 + ストレージ | △（スケールダウン可能） | アーカイブ層用。ストレージ課金は継続 |

---

## 4. 課金モデルごとの特徴と考慮点

- **リクエスト課金型**：スタート段階ではコスト最小。利用増加に比例してコスト増大。
- **時間課金型**：初期コスト高めだが、一定規模を超えると安定。停止可否が削減余地に直結。
- **ハイブリッド型（Lambda）**：リクエストと実行時間両方が関係。Provisioned Concurrency 利用時は時間課金部分が増加。
- **停止可能性の重要性**：RDS や ECS などは停止でコスト削減可能だが、OpenSearch や ElastiCache は基本的に常時稼働を前提とするため、スケール設計が重要。

---

## 5. 今後のステップ（コスト試算準備）

次の3フェーズごとに月間利用量を設定すると、AWS サービス別の月額概算を算出できる：

| フェーズ | テナント数 | API リクエスト数 | ログ量 | OpenSearch データ量 |
|----------|------------|------------------|--------|----------------------|
| スタート | 1 | 低頻度（例: 1万/月） | （例: 1GB/月） | （例: 10GB） |
| 拡大期 | 5〜10 | 中頻度（例: 10〜50万/月） | （例: 5GB/月） | （例: 100GB） |
| 最大期 | 50〜100 | 高頻度（例: 100〜500万/月） | （例: 20GB/月） | （例: 1TB） |

※この表に具体値を入れると、AWS Pricing Calculator を用いて精度の高いコストシミュレーションが可能。

---

## 6. 設計上のポイント

- **パフォーマンス要件**（ミリ秒〜1秒）を満たすため、検索は OpenSearch、キーアクセスは DynamoDB を併用。
- **マルチテナント対応**は論理分離（`tenant_id` パーティションキー、Cognito 属性など）で管理。
- **SSO 対応**は Cognito + SAML / OIDC を標準化し、独自 IdP はカスタムフェデレーションで対応。
- **運用設計**では CloudWatch によるメトリクス・ログ収集と、バックアップ自動化（S3 + 別リージョンレプリカ）を必須とする。
- **コスト最適化**には「停止可能なサービスの選定」と「リクエスト課金部分の利用抑制」が鍵となる。

---
